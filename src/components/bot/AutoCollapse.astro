---

---

<script>
	import { TRANSITION_BEFORE_SWAP, isTransitionBeforeSwapEvent } from 'astro:transitions/client';
	import { SIDEBAR_CONTENT as STARLIGHT_SIDEBAR_CONTENT } from 'astro-vtbot/components/starlight/utils';

	document.addEventListener(TRANSITION_BEFORE_SWAP, (e) => {
		if (isTransitionBeforeSwapEvent(e)) {
			e.viewTransition.finished.then(() => {
				collapse();
			});
		}
	});

	function collapse() {
		let current = document.querySelector(`${STARLIGHT_SIDEBAR_CONTENT} [aria-current="page"]`);
		const keepOpen = new Set<HTMLDetailsElement>();
		while ((current = current?.parentElement?.closest('details') ?? null)) {
			keepOpen.add(current as HTMLDetailsElement);
		}
		document
			.querySelectorAll<HTMLDetailsElement>(`${STARLIGHT_SIDEBAR_CONTENT} details`)
			.forEach((d) => {
				if (!keepOpen.has(d) && d.open) {
					d.querySelectorAll('ul a').forEach((a) =>
						a
							.animate(
								{
									opacity: [1, 0],
									fontSize: ['16px','0px'],
								},
								200
							)
							.finished.then(() => (d.open = false))
					);
				}
			});
	}

	collapse();
</script>
