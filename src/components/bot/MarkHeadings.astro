---
export interface Props {
	selector?: string;
}
const { selector } = Astro.props;
---

{selector && <meta name="vtbot-mark-heading-selector" content={selector} />}

<script>
	import { TRANSITION_BEFORE_PREPARATION } from 'astro:transitions/client';

	const selector =
		document.querySelector<HTMLMetaElement>('meta[name="vtbot-mark-heading-prefix"]')?.content ??
		'h1, h2, h3, h4, h5, h6';

	const markHeadings = (doc: Document) => {
		doc
			.querySelectorAll(selector)
			.forEach(
				(e, idx) => ((e as HTMLHeadingElement).style.viewTransitionName ||= 'vtbot-hx-' + idx)
			);
	};

	document.addEventListener(TRANSITION_BEFORE_PREPARATION, (e) => {
		markHeadings(document);
		const originalLoader = e.loader;
		e.loader = async () => {
			await originalLoader();
			markHeadings(e.newDocument);
		};
	});
</script>
