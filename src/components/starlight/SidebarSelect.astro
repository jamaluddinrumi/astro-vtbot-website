---
export interface Props {}
---

<script>
	import {
		type TransitionBeforeSwapEvent,
		isTransitionBeforeSwapEvent,
		TRANSITION_BEFORE_SWAP,
	} from 'astro:transitions/client';
	import { sidebarEntry } from 'astro-vtbot/components/starlight/utils';

	const marker = init();

	function moveMarker(e: TransitionBeforeSwapEvent) {
		const current = sidebarEntry(e.from);
		if (!current || getComputedStyle(current).visibility === 'hidden') return;
		let next = sidebarEntry(e.to);
		if (!next) return;

		const nextRect = next.getBoundingClientRect();
		const currentRect = (current as HTMLElement).parentElement!.getBoundingClientRect();
		marker.style.left = currentRect.left - 8 + 'px';
		marker.style.top = currentRect.top + 'px';
		document.body.appendChild(marker);

		marker
			.animate(
				{
					top: [`${currentRect.top}px`, `${currentRect.top}px`, `${nextRect.top}px`,`${nextRect.top}px`],
					opacity: [0, 1, 1, 0],
					easing: ['ease-in-out'],
				},
				1500
			)
			.finished.then(() => {
				marker.style.top = nextRect.top + 'px';
			});
	}

	function init() {
		const marker = document.createElement('span');
		const current = document.querySelector(`.sidebar-pane [aria-current="page"]`);
		const currentRect = (current as HTMLElement).parentElement!.getBoundingClientRect();
		marker.style.position = 'fixed';
		marker.style.zIndex = '10';
		marker.style.left = currentRect.left - 8 + 'px';
		marker.style.top = currentRect.top + 'px';
		marker.style.height = currentRect.height + 'px';
		marker.style.width = '8px';
		marker.style.backgroundColor = 'var(--sl-color-text-accent)';
		marker.style.opacity = '0';
		document.body.appendChild(marker);

		document.addEventListener(TRANSITION_BEFORE_SWAP, (e) => {
			if (isTransitionBeforeSwapEvent(e)) {
				const originalSwap = e.swap;
				e.swap = () => {
					originalSwap();
					moveMarker(e);
				};
			}
		});
		return marker;
	}
</script>
