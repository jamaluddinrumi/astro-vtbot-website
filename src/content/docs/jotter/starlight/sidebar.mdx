---
title: Updating the Sidebar
---


Visit the [corresponding section in the introduction](/jotter/starlight/#handle-the-sidebar) to see where we are in  the big picture of The Bag's Starlight support.

Since we [only swap the main-frame](/jotter/starlight/app-state/) on transitions, we have to update the current page marker in the sidebar ourselves.

At least that's what I thought.

## What it Could have Been
And that would have been a a nice exercise:
- Remove the `aria-current="page"` attribute where ever it exists in `e.newDocument`. This is  the marker we would update.
- Also in `e.newDocument` find the sidebar entry that links to `e.to.href`. Add the  `aria-current="page"` to that element. Done.
Run all that directly after [the loader](/jotter/astro/loader-swap/#loader) has fetched the new DOM.

## Splash! Sidebar Changes on Navigation

To be honest, I did the exercise above for v1.7.0 of The Bag and thought it was good as it was. But then [I learned it wasn't](https://github.com/martrapp/astro-vtbot/issues/55).
I had another dependency on Starlight's page structure that I wasn't aware of before: If you use the `splash` layout, the sidebar is not created at all.

You may have notice that the Jotter is linked from The Bag's homepage. It doesn't use a splash screen as entry. But almost all others Starlight sites do.


Starting with a splash screen creates an app frame without a sidebar. If you jump to a page with a `doc` template, we keep this app frame and never show a sidebar (until we force the browser to do a full page load). Equally irritating, if you navigate from a `doc` page to a `splash` page, we retain the app frame, which bravely continues to display the sidebar on the splash screen.

So this is the point at which [the first assumption](/jotter/starlight/app-state/#the-assumptions) proved to be wrong.

## Swapping the Sidebar

We can't just add `data-vtbot-replace` to the sidebar and trust the `<ReplacementSwap/>` component to do it right. It would work to throw away the sidebar when navigating to a splash page, but it might not add a missing sidebar.  But the special handling we need for the sidebar is very similar to what `ReplacementSwap` does internally.

ðŸ”“ This now reveals what is behind [Line 19](/jotter/starlight/integration/#connecting-to-starlight) of the StarlightConnector.

```ts title="astro-vtbot/components/starlight/StarlightConnector.astro" showLineNumbers=false
function updateSidebar(e: TransitionBeforeSwapEvent) {
		const newSidebar = e.newDocument.querySelector(STARLIGHT_SIDEBAR);
		if (!newSidebar) {
			document.querySelector(STARLIGHT_SIDEBAR)?.remove();
		} else {
			const sidebar = document.querySelector(STARLIGHT_SIDEBAR);
			if (!sidebar) {
				document
					.querySelector(STARLIGHT_MAIN_FRAME)
					?.insertAdjacentElement('beforebegin', newSidebar);
			} else {
				const oldContent = sidebar.querySelector(STARLIGHT_SIDEBAR_CONTENT);
				const newContent = newSidebar.querySelector(STARLIGHT_SIDEBAR_CONTENT);
				if (oldContent && newContent) {
					oldContent.replaceWith(newContent);
				} else {
					sidebar.replaceWith(newSidebar);
				}
			}
		}
	}
```
- If we do have a sidebar, but the new page shouldn't, we drop it.
- If we don't have a sidebar but the new page should have one, we add it.
- If both pages have a sidebar, we copy the new content to the current sidebar.

Note that we try to avoid copying the sidebar itself to keep the current scroll position for longer sidebars.

## And the Current Page Marker?
That does not need special attention any more. The `aria-current="page"` is automatically updated when copying the sidebar content. This would even work if the collapse

## And the Menu button?

ðŸ”“ How do we close the mobile menu in the navigation? Oh, yes. It's a bit like an advent calendar. This reveals what is hidden behind [Line 14](/jotter/starlight/integration/#connecting-to-starlight) of the StarlightConnector.

```ts title="astro-vtbot/components/starlight/StarlightConnector.astro" showLineNumbers=false
	function closeMobileMenu() {
		if (document.body.hasAttribute(STARLIGHT_MOBILE_MENU_EXPANDED)) {
			document.body
				.querySelector(STARLIGHT_MENU_BUTTON)
				?.closest('nav')
				?.dispatchEvent(
					new KeyboardEvent('keyup', {
						key: 'Escape',
						code: 'Escape',
						charCode: 27,
						keyCode: 27,
						shiftKey: false,
						ctrlKey: false,
						altKey: false,
						metaKey: false,
					})
				);
		}
	}
```
It just presses the escape key.
